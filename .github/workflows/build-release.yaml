name: Build Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Input Version: '
        required: true
        type: string
      publish_release:
        description: 'Publish GitHub Release: '
        required: true
        type: choice
        options: ["false", "true"]
        default: "false"
      version_suffix:
        description: 'App - YinnClash MetaBoxUi'
        required: false
        type: string
        default: ""

jobs:
  BuildRelease:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout submodules
        run: git submodule update --init --recursive --force

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.23.x"
          check-latest: true

      - name: Cache Go
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Convert and set version env
        id: process-version
        shell: bash
        run: |
          VERSION_INPUT="${{ inputs.version }}"
          VERSION_INPUT="${VERSION_INPUT#v}"  # remove leading v if exists

          if [[ ! "$VERSION_INPUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format. Use x.y.z or vx.y.z (contoh: 2.11.22 / v2.11.22)"
            exit 1
          fi

          IFS='.' read -ra V <<< "$VERSION_INPUT"
          VERSION_CODE=$(printf "%1d%02d%03d" "${V[0]}" "${V[1]}" "${V[2]}")

          SUFFIX="${{ inputs.version_suffix }}"
          VERSION_NAME="${VERSION_INPUT}${SUFFIX}"

          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION_INPUT" >> $GITHUB_OUTPUT

          echo "VersionName: $VERSION_NAME"
          echo "VersionCode: $VERSION_CODE"
          echo "Tag: v$VERSION_INPUT"

      - name: Re-write version
        uses: Devofure/advance-android-version-actions@v1.5
        with:
          gradlePath: build.gradle.kts
          versionCode: ${{ steps.process-version.outputs.versionCode }}
          versionName: ${{ steps.process-version.outputs.versionName }}

      - name: Commit changes locally (no push)
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add build.gradle.kts || true
          git commit -m "Bump version to ${{ steps.process-version.outputs.versionName }} (${{ steps.process-version.outputs.versionCode }})" || true

      - name: Update CA
        run: |
          sudo apt-get update && sudo apt-get install -y ca-certificates
          sudo update-ca-certificates
          cp -f /etc/ssl/certs/ca-certificates.crt core/src/foss/golang/clash/component/ca/ca-certificates.crt

      # Signing hanya untuk publish release (MetaRelease butuh keystore)
      - name: Signing properties
        if: ${{ inputs.publish_release == 'true' }}
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: |
          touch signing.properties
          echo keystore.password="$SIGNING_STORE_PASSWORD" > signing.properties
          echo key.alias="$SIGNING_KEY_ALIAS" >> signing.properties
          echo key.password="$SIGNING_KEY_PASSWORD" >> signing.properties

      # âœ… FIX UTAMA:
      # - publish_release=false  => build MetaDebug (no keystore, auto-signed debug)
      # - publish_release=true   => build MetaRelease (signed)
      - name: Build APK (MetaDebug if no publish)
        shell: bash
        run: |
          if [ "${{ inputs.publish_release }}" = "true" ]; then
            echo "Building MetaRelease (SIGNED)..."
            ./gradlew --no-daemon app:assembleMetaRelease --stacktrace --info
          else
            echo "Building MetaDebug (NO KEYSTORE)..."
            ./gradlew --no-daemon app:assembleMetaDebug --stacktrace --info
          fi

      # Selalu upload artifact biar bisa download dari Actions
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        if: ${{ success() }}
        with:
          name: apks
          path: |
            app/build/outputs/apk/**/**/*.apk

      # Tag + GitHub Release hanya kalau publish_release=true
      - name: Create Tag
        if: ${{ inputs.publish_release == 'true' }}
        run: |
          git tag "${{ steps.process-version.outputs.tag }}" || true
          git push origin "${{ steps.process-version.outputs.tag }}" || true

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: ${{ inputs.publish_release == 'true' && success() }}
        with:
          tag_name: ${{ steps.process-version.outputs.tag }}
          files: app/build/outputs/apk/meta/release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}