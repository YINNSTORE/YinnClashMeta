name: Build Release

on:
  workflow_dispatch:
    inputs:
      release-tag:
        description: "Release Tag (v2.x.x)"
        required: true
        type: string

      publish_release:
        description: "Upload to GitHub Release?"
        required: true
        type: choice
        options: ["false", "true"]
        default: "false"

jobs:
  BuildRelease:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags (fix changelog/tag issues)
        shell: bash
        run: |
          git fetch --force --tags

      - name: Checkout submodules
        run: git submodule update --init --recursive --force

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          check-latest: true

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Convert and set version env
        id: process-version
        shell: bash
        run: |
          VERSION_TAG="${{ inputs.release-tag }}"
          VERSION_TAG="${VERSION_TAG#v}"

          # basic check x.y.z
          if [[ ! "$VERSION_TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format. Use vX.Y.Z (contoh: v2.11.22)"
            exit 1
          fi

          IFS='.' read -ra V <<< "$VERSION_TAG"
          VERSION_CODE=$(printf "%1d%02d%03d" "${V[0]}" "${V[1]}" "${V[2]}")

          echo "versionName=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT

          echo "VersionName: $VERSION_TAG"
          echo "VersionCode: $VERSION_CODE"

      - name: Re-write version
        uses: Devofure/advance-android-version-actions@v1.5
        with:
          gradlePath: build.gradle.kts
          versionCode: ${{ steps.process-version.outputs.versionCode }}
          versionName: ${{ steps.process-version.outputs.versionName }}

      - name: Commit and push if changes
        shell: bash
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

          # commit if changed
          if ! git diff --quiet; then
            git add build.gradle.kts
            git commit -m "Bump version to ${{ steps.process-version.outputs.versionName }} (${{ steps.process-version.outputs.versionCode }})" || true
            git push || true
          fi

          # create tag (local + push) biar changelog/relase kebaca
          git tag "${{ inputs.release-tag }}" || true
          git push origin "${{ inputs.release-tag }}" || true

      - name: Update CA
        run: |
          sudo apt-get update && sudo apt-get install -y ca-certificates
          sudo update-ca-certificates
          cp -f /etc/ssl/certs/ca-certificates.crt core/src/foss/golang/clash/component/ca/ca-certificates.crt

      - name: Decode release keystore
        shell: bash
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          ls -lah release.keystore

      - name: Verify keystore alias & password
        shell: bash
        run: |
          keytool -list -keystore release.keystore \
            -alias "${{ secrets.SIGNING_KEY_ALIAS }}" \
            -storepass "${{ secrets.SIGNING_STORE_PASSWORD }}" >/dev/null
          echo "Keystore OK ✅"

      - name: Signing properties
        shell: bash
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: |
          cat > signing.properties <<EOF
          keystore.password=$SIGNING_STORE_PASSWORD
          key.alias=$SIGNING_KEY_ALIAS
          key.password=$SIGNING_KEY_PASSWORD
          EOF
          echo "signing.properties created ✅"

      - name: Release Build
        run: ./gradlew --no-daemon app:assembleMetaRelease

      # ✅ Ambil 1 APK aja: arm64-v8a (bukan universal)
      - name: Pick single APK (arm64-v8a) and rename
        shell: bash
        run: |
          APK_PATH="$(ls -1 app/build/outputs/apk/meta/release/*arm64-v8a*-release*.apk | head -n 1)"
          if [ -z "$APK_PATH" ]; then
            echo "arm64-v8a APK not found!"
            ls -lah app/build/outputs/apk/meta/release/ || true
            exit 1
          fi

          OUT="YinnClash-${{ inputs.release-tag }}-arm64.apk"
          cp "$APK_PATH" "$OUT"
          echo "Selected: $APK_PATH"
          echo "Output: $OUT"
          ls -lah "$OUT"

      # ✅ Upload Release: hanya kalau publish_release=true
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: ${{ inputs.publish_release == 'true' && success() }}
        with:
          tag_name: ${{ inputs.release-tag }}
          files: YinnClash-${{ inputs.release-tag }}-arm64.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ✅ Changelog builder: jangan bikin workflow fail kalau tag sebelumnya belum ada
      - name: Release Changelog Builder
        if: ${{ inputs.publish_release == 'true' && success() }}
        uses: mikepenz/release-changelog-builder-action@v4.1.1
        continue-on-error: true
        with:
          configurationJson: |
            {
              "ignore_labels": ["Update"]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}